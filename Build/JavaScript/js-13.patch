From 9a9c1881a149d39c9419e441d9065c0b93cbe0f4 Mon Sep 17 00:00:00 2001
From: Achim Fritz <achim.fritz@b13.com>
Date: Sun, 21 Apr 2024 17:25:12 +0200
Subject: [PATCH] [TASK] js-13

---
 .../backend/layout-module/drag-drop.ts        | 27 +++++++++++++++----
 .../TypeScript/backend/layout-module/paste.ts | 21 ++++++++++-----
 2 files changed, 36 insertions(+), 12 deletions(-)

diff --git a/Build/Sources/TypeScript/backend/layout-module/drag-drop.ts b/Build/Sources/TypeScript/backend/layout-module/drag-drop.ts
index 897f3d390b..ee877f3094 100644
--- a/Build/Sources/TypeScript/backend/layout-module/drag-drop.ts
+++ b/Build/Sources/TypeScript/backend/layout-module/drag-drop.ts
@@ -20,11 +20,11 @@ import { BaseEvent } from '@interactjs/core/BaseEvent';
 import { Interactable } from '@interactjs/core/Interactable';
 import { DragEvent } from '@interactjs/actions/drag/plugin';
 import { DropEvent } from '@interactjs/actions/drop/DropEvent';
-import DocumentService from '@typo3/core/document-service';
-import DataHandler from '../ajax-data-handler';
-import Icons from '../icons';
-import ResponseInterface from '../ajax-data-handler/response-interface';
-import RegularEvent from '@typo3/core/event/regular-event';
+import DocumentService from '@typo3/core/document-service.js';
+import DataHandler from '@typo3/backend/ajax-data-handler.js';
+import Icons from '@typo3/backend/icons.js';
+import ResponseInterface from '@typo3/backend/ajax-data-handler/response-interface.js';
+import RegularEvent from '@typo3/core/event/regular-event.js';
 
 interface Parameters {
   cmd?: { [key: string]: { [key: string]: any } };
@@ -194,6 +194,7 @@ class DragDrop {
     const dropContainer = e.target as HTMLElement;
     const draggedElement = e.relatedTarget as HTMLElement;
     const newColumn = DragDrop.getColumnPositionForElement(dropContainer);
+    const newTxContainerParent = DragDrop.getTxContainerParentPositionForElement(dropContainer);
     const contentElementUid: number = parseInt(draggedElement.dataset.uid, 10);
 
     if (typeof (contentElementUid) === 'number' && contentElementUid > 0) {
@@ -218,9 +219,12 @@ class DragDrop {
       }
 
       let colPos: number | boolean = 0;
+      let txContainerParent: number = 0;
       if (targetPid !== 0) {
         colPos = newColumn;
+        txContainerParent = newTxContainerParent;
       }
+
       const isCopyAction = (e.dragEvent.ctrlKey || dropContainer.classList.contains('t3js-paste-copy'));
       const datahandlerCommand = isCopyAction ? 'copy' : 'move';
       parameters.cmd = {
@@ -232,6 +236,7 @@ class DragDrop {
               update: {
                 colPos: colPos,
                 sys_language_uid: language,
+                tx_container_parent: txContainerParent,
               },
             }
           }
@@ -300,6 +305,18 @@ class DragDrop {
     }
     return false;
   }
+
+  /**
+   * @param element HTMLElement
+   * @return int
+   */
+  private static getTxContainerParentPositionForElement(element: HTMLElement) {
+    const columnContainer = element.closest('[data-tx-container-parent]') as HTMLElement;
+    if (columnContainer !== null && columnContainer.dataset.txContainerParent !== undefined) {
+      return parseInt(columnContainer.dataset.txContainerParent, 10);
+    }
+    return 0;
+  }
 }
 
 export default new DragDrop();
diff --git a/Build/Sources/TypeScript/backend/layout-module/paste.ts b/Build/Sources/TypeScript/backend/layout-module/paste.ts
index 64b38ad534..b8d91e5d3f 100644
--- a/Build/Sources/TypeScript/backend/layout-module/paste.ts
+++ b/Build/Sources/TypeScript/backend/layout-module/paste.ts
@@ -11,20 +11,20 @@
  * The TYPO3 project - inspiring people to share!
  */
 
-import DocumentService from '@typo3/core/document-service';
+import DocumentService from '@typo3/core/document-service.js';
 /**
  * Module: @typo3/backend/layout-module/paste
  * Dynamically adds "Paste" Icons in the Page Layout module (Web => Page)
  * and triggers a modal window. which then calls the AjaxDataHandler
  * to execute the action to paste the current clipboard contents.
  */
-import ResponseInterface from '../ajax-data-handler/response-interface';
-import DataHandler from '../ajax-data-handler';
+import ResponseInterface from '@typo3/backend/ajax-data-handler/response-interface.js';
+import DataHandler from '@typo3/backend/ajax-data-handler.js';
 import { default as Modal, ModalElement, Button } from '@typo3/backend/modal';
-import Severity from '../severity';
-import '@typo3/backend/element/icon-element';
-import { SeverityEnum } from '../enum/severity';
-import RegularEvent from '@typo3/core/event/regular-event';
+import Severity from '@typo3/backend/severity.js';
+import '@typo3/backend/element/icon-element.js';
+import { SeverityEnum } from '@typo3/backend/enum/severity.js';
+import RegularEvent from '@typo3/core/event/regular-event.js';
 
 type PasteOptions = {
   itemOnClipboardUid: number;
@@ -62,6 +62,11 @@ class Paste {
     return parseInt(columnContainer?.dataset?.colpos ?? '0', 10);
   }
 
+  private static determineTxContainerParent($element: HTMLElement): number {
+    const columnContainer = $element.closest('[data-tx-container-parent]') as HTMLElement|null;
+    return parseInt(columnContainer?.dataset?.txContainerParent ?? '0', 10);
+  }
+
   private initializeEvents(): void
   {
     new RegularEvent('click', (evt: Event, target: HTMLElement): void => {
@@ -134,6 +139,7 @@ class Paste {
    */
   private execute(element: HTMLElement): void {
     const colPos = Paste.determineColumn(element);
+    const txContainerParent = Paste.determineTxContainerParent(element);
     const closestElement = element.closest(this.elementIdentifier) as HTMLElement;
     const targetFound = closestElement.dataset.uid;
     let targetPid;
@@ -150,6 +156,7 @@ class Paste {
         update: {
           colPos: colPos,
           sys_language_uid: language,
+          tx_container_parent: txContainerParent,
         },
       },
     };
-- 
2.39.2 (Apple Git-143)

